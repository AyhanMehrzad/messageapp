"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[640],{9570:(e,t,n)=>{n.d(t,{N:()=>b});var r=n(579),o=n(5043),c=n(2190),s=n(4930),i=n(293),a=n(2555),l=n(9674),u=n(8676),d=n(1051);function p(e,t){if("function"===typeof e)return e(t);null!==e&&void 0!==e&&(e.current=t)}function f(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o.useCallback(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return e=>{let n=!1;const r=t.map(t=>{const r=p(t,e);return n||"function"!==typeof r||(n=!0),r});if(n)return()=>{for(let e=0;e<r.length;e++){const n=r[e];"function"===typeof n?n():p(t[e],null)}}}}(...t),t)}class h extends o.Component{getSnapshotBeforeUpdate(e){const t=this.props.childRef.current;if(t&&e.isPresent&&!this.props.isPresent){const e=t.offsetParent,n=(0,u.s)(e)&&e.offsetWidth||0,r=this.props.sizeRef.current;r.height=t.offsetHeight||0,r.width=t.offsetWidth||0,r.top=t.offsetTop,r.left=t.offsetLeft,r.right=n-r.width-r.left}return null}componentDidUpdate(){}render(){return this.props.children}}function m(e){let{children:t,isPresent:n,anchorX:c,root:s}=e;const i=(0,o.useId)(),a=(0,o.useRef)(null),l=(0,o.useRef)({width:0,height:0,top:0,left:0,right:0}),{nonce:u}=(0,o.useContext)(d.Q),p=f(a,null===t||void 0===t?void 0:t.ref);return(0,o.useInsertionEffect)(()=>{const{width:e,height:t,top:r,left:o,right:d}=l.current;if(n||!a.current||!e||!t)return;const p="left"===c?"left: ".concat(o):"right: ".concat(d);a.current.dataset.motionPopId=i;const f=document.createElement("style");u&&(f.nonce=u);const h=null!==s&&void 0!==s?s:document.head;return h.appendChild(f),f.sheet&&f.sheet.insertRule('\n          [data-motion-pop-id="'.concat(i,'"] {\n            position: absolute !important;\n            width: ').concat(e,"px !important;\n            height: ").concat(t,"px !important;\n            ").concat(p,"px !important;\n            top: ").concat(r,"px !important;\n          }\n        ")),()=>{h.contains(f)&&h.removeChild(f)}},[n]),(0,r.jsx)(h,{isPresent:n,childRef:a,sizeRef:l,children:o.cloneElement(t,{ref:p})})}const v=e=>{let{children:t,initial:n,isPresent:c,onExitComplete:i,custom:u,presenceAffectsLayout:d,mode:p,anchorX:f,root:h}=e;const v=(0,s.M)(g),y=(0,o.useId)();let x=!0,w=(0,o.useMemo)(()=>(x=!1,{id:y,initial:n,isPresent:c,custom:u,onExitComplete:e=>{v.set(e,!0);for(const t of v.values())if(!t)return;i&&i()},register:e=>(v.set(e,!1),()=>v.delete(e))}),[c,v,i]);return d&&x&&(w=(0,a.A)({},w)),(0,o.useMemo)(()=>{v.forEach((e,t)=>v.set(t,!1))},[c]),o.useEffect(()=>{!c&&!v.size&&i&&i()},[c]),"popLayout"===p&&(t=(0,r.jsx)(m,{isPresent:c,anchorX:f,root:h,children:t})),(0,r.jsx)(l.t.Provider,{value:w,children:t})};function g(){return new Map}var y=n(8917);const x=e=>e.key||"";function w(e){const t=[];return o.Children.forEach(e,e=>{(0,o.isValidElement)(e)&&t.push(e)}),t}const b=e=>{let{children:t,custom:n,initial:a=!0,onExitComplete:l,presenceAffectsLayout:u=!0,mode:d="sync",propagate:p=!1,anchorX:f="left",root:h}=e;const[m,g]=(0,y.xQ)(p),b=(0,o.useMemo)(()=>w(t),[t]),j=p&&!m?[]:b.map(x),R=(0,o.useRef)(!0),k=(0,o.useRef)(b),C=(0,s.M)(()=>new Map),[P,S]=(0,o.useState)(b),[N,E]=(0,o.useState)(b);(0,i.E)(()=>{R.current=!1,k.current=b;for(let e=0;e<N.length;e++){const t=x(N[e]);j.includes(t)?C.delete(t):!0!==C.get(t)&&C.set(t,!1)}},[N,j.length,j.join("-")]);const M=[];if(b!==P){let e=[...b];for(let t=0;t<N.length;t++){const n=N[t],r=x(n);j.includes(r)||(e.splice(t,0,n),M.push(n))}return"wait"===d&&M.length&&(e=M),E(w(e)),S(b),null}const{forceRender:T}=(0,o.useContext)(c.L);return(0,r.jsx)(r.Fragment,{children:N.map(e=>{const t=x(e),o=!(p&&!m)&&(b===N||j.includes(t));return(0,r.jsx)(v,{isPresent:o,initial:!(R.current&&!a)&&void 0,custom:n,presenceAffectsLayout:u,mode:d,root:h,onExitComplete:o?void 0:()=>{if(!C.has(t))return;C.set(t,!0);let e=!0;C.forEach(t=>{t||(e=!1)}),e&&(null===T||void 0===T||T(),E(k.current),p&&(null===g||void 0===g||g()),l&&l())},anchorX:f,children:e},t)})})}},9640:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var r=n(5043),o=n(9570),c=n(4119),s=n(579);const i=e=>{let{onSend:t,onSocketAction:n}=e;const[i,a]=(0,r.useState)(""),[l,u]=(0,r.useState)(!1),[d,p]=(0,r.useState)(null),[f,h]=(0,r.useState)(0),[m,v]=(0,r.useState)(!1),[g,y]=(0,r.useState)("user"),x=(0,r.useRef)(null),w=(0,r.useRef)(null),b=(0,r.useRef)([]),j=(0,r.useRef)(null),R=(0,r.useRef)(null),k=(0,r.useRef)(null),C=(0,r.useRef)(null),P=(0,r.useRef)(null),S=(0,r.useRef)(null);(0,r.useEffect)(()=>{x.current&&(x.current.style.height="auto",x.current.style.height=x.current.scrollHeight+"px")},[i]);const N=(0,r.useRef)(null);(0,r.useEffect)(()=>()=>{E()},[]);const E=(0,r.useCallback)(()=>{P.current&&(P.current.getTracks().forEach(e=>e.stop()),P.current=null),k.current&&(k.current.pause(),k.current.srcObject=null),S.current&&(cancelAnimationFrame(S.current),S.current=null),N.current&&(N.current.close(),N.current=null)},[]),M=()=>{i.trim()&&(t(i),a(""),x.current&&(x.current.style.height="auto",x.current.focus()))},T=()=>{if(k.current&&C.current&&!k.current.paused&&!k.current.ended){C.current.getContext("2d").drawImage(k.current,0,0,C.current.width,C.current.height),S.current=requestAnimationFrame(T)}},A=async e=>{try{let t;E();let n="audio/webm";if("video"===e){const e={video:{facingMode:g},audio:!0},r=await navigator.mediaDevices.getUserMedia(e);if(P.current=r,C.current&&k.current){k.current.srcObject=r,await k.current.play(),C.current.width=k.current.videoWidth,C.current.height=k.current.videoHeight,T();const e=C.current.captureStream(30),o=r.getAudioTracks()[0];o&&e.addTrack(o),t=e,n=(()=>{const e=["video/mp4","video/webm;codecs=h264","video/webm"];for(const t of e)if(MediaRecorder.isTypeSupported(t))return t;return"video/webm"})()}}else{const e=await navigator.mediaDevices.getUserMedia({audio:!0});P.current=e,t=e,n="audio/webm"}const r=new MediaRecorder(t,{mimeType:n});if(w.current=r,"video"===e){const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host,n="".concat(e,"//").concat(t,"/ws/chat/stream"),o=new WebSocket(n);N.current=o,o.onopen=()=>{console.log("Video Stream Connected"),r.start(100)},o.onerror=e=>{console.error("WebSocket Error",e)},r.ondataavailable=e=>{e.data.size>0&&o.readyState===WebSocket.OPEN&&o.send(e.data)},r.onstop=()=>{o.readyState===WebSocket.OPEN&&o.close(),E()}}else b.current=[],r.ondataavailable=e=>{e.data.size>0&&b.current.push(e.data)},r.onstop=()=>{const t=new Blob(b.current,{type:n});D(t,e,"webm"),E()},r.start();u(!0),p(e),h(0),j.current=setInterval(()=>{h(e=>e+1)},1e3)}catch(t){console.error("Error accessing media devices:",t),alert("Could not access camera/microphone. Please check permissions.")}},I=()=>{w.current&&l&&(w.current.stop(),u(!1),p(null),clearInterval(j.current))},W=()=>{w.current&&l&&(w.current.onstop=null,w.current.stop(),E(),u(!1),p(null),clearInterval(j.current))},D=async function(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"webm";v(!0);const o=new FormData,c="image"===n?e.name||"image.png":"recording.".concat(r),s=e.name||c;o.append("file",e,s);try{const e=await fetch("/api/upload",{method:"POST",body:o}),r=await e.json();r.url&&t({msg:r.url,type:n})}catch(i){console.error("Upload failed",i),alert("Upload failed.")}finally{v(!1),R.current&&(R.current.value="")}},[L,X]=(0,r.useState)("audio"),U=(0,r.useRef)(0),z=(0,r.useRef)(null),O=(0,r.useRef)(!1),F=(0,r.useRef)(0),H=(0,r.useRef)(0),B={initial:{scale:.8,rotate:-90,opacity:0},animate:{scale:1,rotate:0,opacity:1},exit:{scale:.8,rotate:90,opacity:0},tap:{scale:.9}};return(0,s.jsxs)("div",{className:"message-input-stack",children:[(0,s.jsx)(o.N,{children:l&&(0,s.jsxs)(c.P.div,{className:"input-container recording-mode",initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:50},children:[(0,s.jsx)("video",{ref:k,style:{display:"none"},playsInline:!0,muted:!0,autoPlay:!0}),"video"===d&&(0,s.jsxs)("div",{className:"video-preview-circle-container",children:[(0,s.jsx)("canvas",{ref:C,className:"video-preview-feed-circle",style:{transform:"user"===g?"scaleX(-1)":"none"}}),(0,s.jsx)("div",{className:"recording-pulse-border"})]}),(0,s.jsxs)("div",{className:"recording-status",children:[(0,s.jsx)("span",{className:"rec-dot"}),(0,s.jsx)("span",{className:"rec-time",children:(e=>{const t=Math.floor(e/60),n=e%60;return"".concat(t,":").concat(n<10?"0":"").concat(n)})(f)}),O.current&&(0,s.jsx)("span",{className:"rec-locked",children:"\ud83d\udd12 Locked"})]}),(0,s.jsxs)("div",{className:"recording-controls",children:[(0,s.jsx)("button",{className:"btn-cancel-rec",onClick:W,children:"Cancel"}),(0,s.jsx)("button",{className:"btn-send-rec",onClick:I,children:"Stop & Send"})]})]})}),!l&&(0,s.jsxs)("div",{className:"input-pill-container",children:[(0,s.jsx)(c.P.button,{className:"pin-btn",onClick:()=>R.current.click(),whileTap:{scale:.9},children:"\ud83d\udcce"}),(0,s.jsxs)("div",{className:"input-pill-box",children:[(0,s.jsx)("textarea",{ref:x,className:"input-field-pill",placeholder:"Message...",value:i,onChange:e=>a(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),M())},rows:1,disabled:m}),(0,s.jsx)(o.N,{mode:"popLayout",children:i.trim()?(0,s.jsx)(c.P.button,{className:"send-btn-pill",onClick:M,variants:B,initial:"initial",animate:"animate",exit:"exit",whileTap:"tap",children:"\u27a4"},"send"):(0,s.jsx)(c.P.div,{className:"media-gesture-btn",onPointerDown:e=>{U.current=Date.now(),O.current=!1,F.current=e.clientY,H.current=e.clientX,z.current=setTimeout(()=>{A(L)},200)},onPointerUp:e=>{clearTimeout(z.current);const t=Date.now()-U.current;l?O.current||I():t<200&&X(e=>"audio"===e?"video":"audio")},onPointerMove:e=>{if(!l||O.current)return;const t=F.current-e.clientY,n=H.current-e.clientX;t>60&&(O.current=!0),n>60&&W()},onPointerLeave:W,variants:B,initial:"initial",animate:"animate",exit:"exit",whileTap:"tap",style:{cursor:"pointer",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",background:"transparent"},children:"audio"===L?"\ud83c\udfa4":"\ud83d\udcf9"},"media")})]})]}),(0,s.jsx)("input",{type:"file",ref:R,style:{display:"none"},onChange:e=>{const t=e.target.files[0];if(t){let e="file",n=t.name.split(".").pop();t.type.startsWith("image/")?e="image":t.type.startsWith("video/")?e="video":t.type.startsWith("audio/")&&(e="audio"),D(t,e,n)}},accept:"image/*,video/*,audio/*"})]})}}}]);
//# sourceMappingURL=640.c7ec3e1d.chunk.js.map