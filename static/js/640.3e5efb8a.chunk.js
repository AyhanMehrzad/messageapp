"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[640],{9640:(e,t,n)=>{n.r(t),n.d(t,{default:()=>s});var r=n(5043),a=n(9570),i=n(4119),c=n(579);const s=(0,r.forwardRef)((e,t)=>{let{onSend:n,onSocketAction:s}=e;const[o,l]=(0,r.useState)(""),[u,d]=(0,r.useState)(!1),[p,m]=(0,r.useState)(null),[f,h]=(0,r.useState)(0),[g,x]=(0,r.useState)(!1),[y,b]=(0,r.useState)("user"),v=(0,r.useRef)(null),w=(0,r.useRef)(null),j=(0,r.useRef)([]),k=(0,r.useRef)(null),S=(0,r.useRef)(null),N=(0,r.useRef)(null),R=(0,r.useRef)(null),C=(0,r.useRef)(null),P=(0,r.useRef)(null);(0,r.useEffect)(()=>{v.current&&(v.current.style.height="auto",v.current.style.height=v.current.scrollHeight+"px")},[o]);const T=(0,r.useRef)(null);(0,r.useImperativeHandle)(t,()=>({stopHardware:()=>{M(),I()}})),(0,r.useEffect)(()=>()=>{I()},[]);const I=(0,r.useCallback)(()=>{C.current&&(C.current.getTracks().forEach(e=>e.stop()),C.current=null),N.current&&(N.current.pause(),N.current.srcObject=null),P.current&&(cancelAnimationFrame(P.current),P.current=null),T.current&&(T.current.close(),T.current=null)},[]),W=()=>{o.trim()&&(n(o),l(""),v.current&&(v.current.style.height="auto",v.current.focus()))},z=()=>{if(N.current&&R.current&&!N.current.paused&&!N.current.ended){R.current.getContext("2d").drawImage(N.current,0,0,R.current.width,R.current.height),P.current=requestAnimationFrame(z)}},D=async e=>{try{let t;I();let n="audio/webm";if("video"===e){const e={video:{facingMode:y},audio:!0},r=await navigator.mediaDevices.getUserMedia(e);if(C.current=r,R.current&&N.current){N.current.srcObject=r,await N.current.play(),R.current.width=N.current.videoWidth,R.current.height=N.current.videoHeight,z();const e=R.current.captureStream(30),a=r.getAudioTracks()[0];a&&e.addTrack(a),t=e,n=(()=>{const e=["video/mp4","video/webm;codecs=h264","video/webm"];for(const t of e)if(MediaRecorder.isTypeSupported(t))return t;return"video/webm"})()}}else{const e=await navigator.mediaDevices.getUserMedia({audio:!0});C.current=e,t=e,n="audio/webm"}const r=new MediaRecorder(t,{mimeType:n});if(w.current=r,"video"===e){const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host,n="".concat(e,"//").concat(t,"/ws/chat/stream"),a=new WebSocket(n);T.current=a,a.onopen=()=>{console.log("Video Stream Connected"),r.start(100)},a.onerror=e=>{console.error("WebSocket Error",e)},r.ondataavailable=e=>{e.data.size>0&&a.readyState===WebSocket.OPEN&&a.send(e.data)},r.onstop=()=>{a.readyState===WebSocket.OPEN&&a.close(),I()}}else j.current=[],r.ondataavailable=e=>{e.data.size>0&&j.current.push(e.data)},r.onstop=()=>{const t=new Blob(j.current,{type:n});H(t,e,"webm"),I()},r.start();d(!0),m(e),h(0),k.current=setInterval(()=>{h(e=>e+1)},1e3)}catch(t){console.error("Error accessing media devices:",t),alert("Could not access camera/microphone. Please check permissions.")}},E=()=>{w.current&&u&&(w.current.stop(),d(!1),m(null),clearInterval(k.current))},M=()=>{w.current&&u&&(w.current.onstop=null,w.current.stop(),I(),d(!1),m(null),clearInterval(k.current))},H=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"webm";x(!0);const a=new FormData,i="image"===t?e.name||"image.png":"recording.".concat(r),c=e.name||i;a.append("file",e,c);try{const e=await fetch("/api/upload",{method:"POST",body:a}),r=await e.json();r.url&&n({msg:r.url,type:t})}catch(s){console.error("Upload failed",s),alert("Upload failed.")}finally{x(!1),S.current&&(S.current.value="")}},[O,U]=(0,r.useState)("audio"),A=(0,r.useRef)(0),F=(0,r.useRef)(null),L=(0,r.useRef)(!1),X=(0,r.useRef)(0),K=(0,r.useRef)(0),Y={initial:{scale:.8,rotate:-90,opacity:0},animate:{scale:1,rotate:0,opacity:1},exit:{scale:.8,rotate:90,opacity:0},tap:{scale:.9}};return(0,c.jsxs)("div",{className:"message-input-stack",children:[(0,c.jsx)(a.N,{children:u&&(0,c.jsxs)(i.P.div,{className:"input-container recording-mode",initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:50},children:[(0,c.jsx)("video",{ref:N,style:{display:"none"},playsInline:!0,muted:!0,autoPlay:!0}),"video"===p&&(0,c.jsxs)("div",{className:"video-preview-circle-container",children:[(0,c.jsx)("canvas",{ref:R,className:"video-preview-feed-circle",style:{transform:"user"===y?"scaleX(-1)":"none"}}),(0,c.jsx)("div",{className:"recording-pulse-border"})]}),(0,c.jsxs)("div",{className:"recording-status",children:[(0,c.jsx)("span",{className:"rec-dot"}),(0,c.jsx)("span",{className:"rec-time",children:(e=>{const t=Math.floor(e/60),n=e%60;return"".concat(t,":").concat(n<10?"0":"").concat(n)})(f)}),L.current&&(0,c.jsx)("span",{className:"rec-locked",children:"\ud83d\udd12 Locked"})]}),(0,c.jsxs)("div",{className:"recording-controls",children:[(0,c.jsx)("button",{className:"btn-cancel-rec",onClick:M,children:"Cancel"}),(0,c.jsx)("button",{className:"btn-send-rec",onClick:E,children:"Stop & Send"})]})]})}),!u&&(0,c.jsxs)("div",{className:"input-pill-container",style:{display:"flex",alignItems:"flex-end",gap:"8px",width:"100%",maxWidth:"700px",margin:"0 auto"},children:[(0,c.jsxs)("div",{className:"input-pill-box",style:{flex:1,background:"#fff",borderRadius:"24px",display:"flex",alignItems:"center",padding:"6px 12px",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[(0,c.jsx)(a.N,{mode:"wait",children:o.startsWith("/")?(0,c.jsx)(i.P.button,{className:"pin-btn bot-cmd-btn",onClick:()=>{},initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},exit:{scale:0,rotate:180},transition:{type:"spring",stiffness:300,damping:20},style:{color:"#3390ec",marginRight:"8px",background:"none",border:"none",cursor:"pointer",fontSize:"20px"},children:"\ud83e\udd16"},"bot-cmd"):(0,c.jsx)(i.P.button,{className:"pin-btn",onClick:()=>S.current.click(),whileTap:{scale:.9},initial:{scale:0,rotate:180},animate:{scale:1,rotate:0},exit:{scale:0,rotate:-180},transition:{type:"spring",stiffness:300,damping:20},style:{color:"#707579",marginRight:"8px",background:"none",border:"none",cursor:"pointer",fontSize:"22px"},children:"\ud83d\udcce"},"attach")}),(0,c.jsx)("textarea",{ref:v,className:"input-field-pill",placeholder:"Message",value:o,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),W())},rows:1,disabled:g,style:{flex:1,border:"none",outline:"none",resize:"none",fontSize:"16px",maxHeight:"100px",padding:"4px 0",fontFamily:"inherit"}}),(0,c.jsx)("button",{className:"emoji-btn",onClick:()=>{},style:{background:"none",border:"none",cursor:"pointer",fontSize:"22px",marginLeft:"8px",color:"#707579"},children:"\ud83d\ude0a"})]}),(0,c.jsx)("div",{className:"action-btn-circle",style:{width:"48px",height:"48px",flexShrink:0},children:(0,c.jsx)(a.N,{mode:"popLayout",children:o.trim()?(0,c.jsx)(i.P.button,{className:"send-btn-pill",onClick:W,variants:Y,initial:"initial",animate:"animate",exit:"exit",whileTap:"tap",transition:{type:"spring",stiffness:300,damping:20},style:{width:"100%",height:"100%",borderRadius:"50%",background:"#3390ec",color:"#fff",border:"none",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:"20px"},children:"\u27a4"},"send"):(0,c.jsx)(i.P.div,{className:"media-gesture-btn",onPointerDown:e=>{A.current=Date.now(),L.current=!1,X.current=e.clientY,K.current=e.clientX,F.current=setTimeout(()=>{D(O)},200)},onPointerUp:e=>{clearTimeout(F.current);const t=Date.now()-A.current;u?L.current||E():t<200&&U(e=>"audio"===e?"video":"audio")},onPointerMove:e=>{if(!u||L.current)return;const t=X.current-e.clientY,n=K.current-e.clientX;t>60&&(L.current=!0),n>60&&M()},onPointerLeave:M,variants:Y,initial:"initial",animate:"animate",exit:"exit",whileTap:"tap",transition:{type:"spring",stiffness:300,damping:20},style:{width:"100%",height:"100%",borderRadius:"50%",background:"#f5f5f5",color:"#707579",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:"24px"},children:"audio"===O?"\ud83c\udfa4":"\ud83d\udcf9"},"media")})})]}),(0,c.jsx)("input",{type:"file",ref:S,style:{display:"none"},onChange:e=>{const t=e.target.files[0];if(t){let e="file",n=t.name.split(".").pop();t.type.startsWith("image/")?e="image":t.type.startsWith("video/")?e="video":t.type.startsWith("audio/")&&(e="audio"),H(t,e,n)}},accept:"image/*,video/*,audio/*"})]})})}}]);
//# sourceMappingURL=640.3e5efb8a.chunk.js.map